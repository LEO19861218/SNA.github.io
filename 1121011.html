<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Key Opinion Leaders Social Network Analysis</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <style>
        /* 新增樣式，將下拉式選單樣式設置為固定位置和寬度 */
        #authorDropdown {
            width: 150px;
        }

        /* 移除 SVG 容器的寬高屬性 */
        #graph-svg-container {
            /* 移除原有的 width 和 height 屬性 */
        }
    </style>
</head>
<body>

<!-- 添加一个容器来呈现图形 -->
<div id="graph-container">
    <h1>Key Opinion Leaders Social Network Analysis</h1>
    <p>This is a dynamic network visualization of collaboration among authors.</p>

    <!-- 添加控制按钮 -->
    <div>
        <label>Show/Hide Author Names:</label>
        <input type="checkbox" id="showHideAuthorNames" checked>

        <!-- 移動下拉式選單到這裡 -->
        <select id="authorDropdown">
            <option value="graph_data.json">Tomohiro Fukuda</option>
            <option value="graph2_data.json">Marc Aurel Schnabel</option>
            <option value="graph3_data.json">Matthias Hank Haeusler</option> <!-- 新增选项 -->
            <option value="graph4_data.json">Three author</option> <!-- 新增选项 -->
            <option value="graph5_data.json">All author</option> <!-- 新增选项 -->
            <!-- 添加更多作者的選項 -->
        </select>

        <!-- 新增下拉式選單來選擇中心性參數 -->
        <label>Choose Centrality Measure:</label>
        <select id="centralityDropdown">
            <option value="degree">Degree Centrality</option>
            <option value="betweenness">Betweenness Centrality</option>
            <option value="eigenvector">Eigenvector Centrality</option>
        </select>
    </div>

    <!-- 修改 SVG 容器的寬高 -->
    <div id="graph-svg-container" style="width: 100%; height: 100vh;"></div>
</div>

<script>
// 初始化加載數據
loadData("graph_data.json", "degree");

// 更新所選作者和中心性
function updateAuthorAndCentralitySelection() {
    var selectedFile = authorDropdown.property("value");
    var selectedCentrality = centralityDropdown.property("value");
    
    // 根据所选JSON文件和中心性执行相应的操作
    d3.json(selectedFile).then(function(newData) {
        // 添加顯示新的數據的相關操作
        console.log("Selected File:", selectedFile);
        console.log("Selected Centrality:", selectedCentrality);
        console.log("New Data:", newData);

        // 移除先前的 SVG
        d3.select("#graph-svg-container").select("svg").remove();

        // 加載新的數據
        loadData(selectedFile, selectedCentrality);
    }).catch(function(error) {
        console.error("Error loading data:", error);
    });
}

// 加載數據
function loadData(file, centrality) {
    d3.json(file).then(function(data) {
        // 创建 SVG 元素
        var svg = d3.select("#graph-svg-container")
                    .append("svg")
                    .attr("width", 2000)
                    .attr("height", 2000);

        // 创建力导向图
        var simulation = d3.forceSimulation(data.nodes)
                           .force("link", d3.forceLink(data.links).id(function(d) { return d.id; }))
                           .force("charge", d3.forceManyBody().strength(-50))
                           .force("center", d3.forceCenter(1000, 500))  // 调整这里的位置
                           .force("collide", d3.forceCollide().radius(10).strength(0.5))
                           .on("tick", ticked);

        // 创建颜色比例尺
        var colorScale = d3.scaleLinear()
                           .domain([0, 1])  // 假设中心性的范围在 [0, 1] 之间
                           .range(["lightblue", "orange"]);

        // 添加边
        var link = svg.selectAll("line")
                      .data(data.links)
                      .enter().append("line")
                      .style("stroke", "gray");  // 设置边的颜色为灰色

        // 添加节点
        var node = svg.selectAll("circle")
                      .data(data.nodes)
                      .enter().append("circle")
                      .attr("r", function(d) { 
                          if (centrality === "degree") {
                              return 5 + d.degree_centrality * 20;  // 根据度中心性调整节点的大小
                          } else if (centrality === "betweenness") {
                              return 5 + d.betweenness_centrality * 20;  // 根据介数中心性调整节点的大小
                          } else if (centrality === "eigenvector") {
                              return 5 + d.eigenvector_centrality * 20;  // 根据特征向量中心性调整节点的大小
                          }
                      }) 
                      .style("fill", function(d) { 
                          if (centrality === "degree") {
                              return colorScale(d.degree_centrality);  // 根据度中心性设置节点的颜色
                          } else if (centrality === "betweenness") {
                              return colorScale(d.betweenness_centrality);  // 根据介数中心性设置节点的颜色
                          } else if (centrality === "eigenvector") {
                              return colorScale(d.eigenvector_centrality);  // 根据特征向量中心性设置节点的颜色
                          }
                      }) 
                      .call(d3.drag()  // 添加拖拽行为
                          .on("start", dragstarted)
                          .on("drag", dragged)
                          .on("end", dragended));

        // 添加节点标签
        var label = svg.selectAll(null)
                      .data(data.nodes)
                      .enter().append("text")
                      .text(function(d) { 
                          if (centrality === "degree") {
                              return d.id + " (" + d.degree_centrality.toFixed(2) + ")";  // 顯示節點ID和度中心性數值
                          } else if (centrality === "betweenness") {
                              return d.id + " (" + d.betweenness_centrality.toFixed(2) + ")";  // 顯示節點ID和介数中心性數值
                          } else if (centrality === "eigenvector") {
                              return d.id + " (" + d.eigenvector_centrality.toFixed(2) + ")";  // 顯示節點ID和特征向量中心性數值
                          }
                      }) 
                      .attr("font-size", 8)
                      .attr("dx", 12)
                      .attr("dy", 4)
                      .style("fill", "black");  // 设置节点标签的颜色为黑色

        function ticked() {
            link.attr("x1", function(d) { return d.source.x; })
                .attr("y1", function(d) { return d.source.y; })
                .attr("x2", function(d) { return d.target.x; })
                .attr("y2", function(d) { return d.target.y; });

            node.attr("cx", function(d) { return d.x; })
                .attr("cy", function(d) { return d.y; });

            label.attr("x", function(d) { return d.x; })
                 .attr("y", function(d) { return d.y; });

            // 控制节点标签的可见性
            label.style("display", function(d) {
                return document.getElementById("showHideAuthorNames").checked ? "block" : "none";
            });
        }

        function dragstarted(d) {
            if (!d3.event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(d) {
            d.fx = d3.event.x;
            d.fy = d3.event.y;
        }

        function dragended(d) {
            if (!d3.event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }
    });
}

// 获取控制按钮元素
var showHideAuthorNamesCheckbox = d3.select("#showHideAuthorNames");
var authorDropdown = d3.select("#authorDropdown");
var centralityDropdown = d3.select("#centralityDropdown");  // 新增獲取中心性選單元素

// 监听按钮状态变化
showHideAuthorNamesCheckbox.on("change", updateAuthorNamesVisibility);

// 监听下拉式選單變化
authorDropdown.on("change", updateAuthorAndCentralitySelection);
centralityDropdown.on("change", updateAuthorAndCentralitySelection);  // 新增監聽中心性選單變化

</script>

</body>
</html>
