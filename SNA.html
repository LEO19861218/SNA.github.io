<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Network Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; }
        svg { width: 100%; height: 600px; border: 1px solid #aaa; }
    </style>
</head>
<body>
    <h2>Social Network Visualization from CSV</h2>
    <input type="file" id="upload" accept=".csv">
    <button onclick="processFile()">Generate Graph</button>
    <svg></svg>

    <script>
    let globalCsvData = null;  // To store CSV data globally

    document.getElementById('upload').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                globalCsvData = e.target.result;  // Store CSV data globally
            };
            reader.readAsText(file);
        }
    });

    // Function to process the file and generate the graph
    function processFile() {
        if (globalCsvData) {
            createGraph(globalCsvData);
        } else {
            alert("Please upload a CSV file first.");
        }
    }

    // Function to create the graph from CSV data
    function createGraph(csvData) {
        const data = d3.csvParse(csvData, d3.autoType);
        const links = data.map(d => ({ source: d.work_id, target: d.Order, value: 1 }));
        const nodes = Array.from(new Set(links.flatMap(d => [d.source, d.target])), id => ({ id }));

        const svg = d3.select('svg').html(''); // Clear previous SVG content
        const width = +svg.attr('width');
        const height = +svg.attr('height');

        const simulation = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links).id(d => d.id).distance(100))
            .force("charge", d3.forceManyBody().strength(-400))
            .force("center", d3.forceCenter(width / 2, height / 2));

        const link = svg.append("g")
            .attr("stroke", "#999")
            .selectAll("line")
            .data(links)
            .join("line")
            .attr("stroke-width", 2);

        const node = svg.append("g")
            .attr("stroke", "#fff")
            .attr("stroke-width", 1.5)
            .selectAll("circle")
            .data(nodes)
            .join("circle")
            .attr("r", 5)
            .attr("fill", "#69b3a2")
            .call(drag(simulation));

        node.append("title")
            .text(d => d.id);

        simulation.on("tick", () => {
            link.attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);

            node.attr("cx", d => d.x)
                .attr("cy", d => d.y);
        });

        function drag(simulation) {
          function dragstarted(event) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            event.subject.fx = event.subject.x;
            event.subject.fy = event.subject.y;
          }

          function dragged(event) {
            event.subject.fx = event.x;
            event.subject.fy = event.y;
          }

          function dragended(event) {
            if (!event.active) simulation.alphaTarget(0);
            event.subject.fx = null;
            event.subject.fy = null;
            simulation.alphaTarget(0.3).restart();  // Reheat the simulation to recenter after dragging
          }

          return d3.drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended);
        }
    }
</script>
</body>
</html>
